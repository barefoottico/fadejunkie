<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FadeJunkie – Barber Schools Directory</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: { fj: { 50:'#f8fafc', 900:'#0b0b0c' } }
        }
      }
    };
  </script>

  <!-- Simple dark-mode init -->
  <script>
    (function(){
      const KEY='fj_theme';
      const saved=localStorage.getItem(KEY);
      const prefersDark=window.matchMedia('(prefers-color-scheme: dark)').matches;
      const theme=saved || (prefersDark?'dark':'light');
      if (theme === 'dark') document.documentElement.classList.add('dark');
    })();
  </script>

  <meta name="description" content="Search barber schools by name, city, or ZIP." />
</head>
<body class="bg-zinc-50 text-zinc-900 dark:bg-zinc-900 dark:text-zinc-100">

  <main class="max-w-3xl mx-auto px-6 py-10">
    <header class="mb-6">
      <h1 class="text-2xl sm:text-3xl font-bold tracking-tight">Barber Schools Directory</h1>
      <p class="mt-2 text-sm text-zinc-600 dark:text-zinc-300">
        Search the directory by name, city, or ZIP — or use your location and filter by distance.
      </p>
    </header>

    <!-- Schools widget -->
    <section id="schools" class="scroll-mt-24 py-6 border-t border-zinc-200 dark:border-zinc-800">
      <h3 class="text-xl font-semibold mb-2">Schools Near Me</h3>
      <p class="text-sm text-zinc-600 dark:text-zinc-300">
        Type a school name, city, or ZIP to see matching results. Or use your location plus a radius.
      </p>

      <!-- Controls -->
      <div class="mt-4 flex flex-col sm:flex-row gap-3 max-w-2xl">
        <input
          id="schoolQuery"
          class="flex-1 px-3 py-2 rounded-lg border border-zinc-200 text-sm
                 dark:bg-zinc-900 dark:border-zinc-700 dark:text-zinc-100"
          placeholder="Search by name, city, or ZIP..."
        />
        <div class="flex items-center gap-2 flex-wrap">
          <button
            id="useLocation"
            class="px-3 py-2 rounded-lg border bg-white hover:bg-zinc-100 text-sm
                   dark:bg-zinc-800 dark:border-zinc-700 dark:hover:bg-zinc-700">
            Use my location
          </button>
          <!-- optional reset for standalone -->
          <button
            id="resetSchoolFilters"
            class="px-3 py-2 rounded-lg border bg-white hover:bg-zinc-100 text-xs
                   dark:bg-zinc-800 dark:border-zinc-700 dark:hover:bg-zinc-700">
            Reset
          </button>
        </div>
      </div>

      <!-- Results -->
      <div id="schoolCount" class="mt-3 text-xs text-zinc-500 dark:text-zinc-400">0 results</div>
      <div id="schoolGrid" class="mt-4 grid sm:grid-cols-2 gap-3"></div>

      <!-- Empty state -->
      <div id="schoolEmpty" class="mt-6 text-sm text-zinc-600 dark:text-zinc-300">
        No schools match your search yet. Try a different term.
      </div>
    </section>
  </main>

  <script>
    /* ==========================
       Schools Directory Widget
    ========================== */
    (function(){
      const JSON_URL = "https://raw.githubusercontent.com/barefoottico/fadejunkie/430211070b8512c117a07136e34b087971666571/texas_barber_schools.json";

      const elQuery  = document.getElementById("schoolQuery");
      const elGrid   = document.getElementById("schoolGrid");
      const elEmpty  = document.getElementById("schoolEmpty");
      const elCount  = document.getElementById("schoolCount");
      const btnGeo   = document.getElementById("useLocation");
      const btnReset = document.getElementById("resetSchoolFilters");

      if (!elGrid || !elCount || !elEmpty) return;

      let SCHOOLS = [];
      let filtered = [];
      let userLoc = null; // { lat, lng } when using "Use my location"

      // ---- Radius selector (Exact ZIP / 10 / 25 / 50 mi) ----
      let radiusSelect = null;
      if (elQuery && elQuery.parentElement) {
        radiusSelect = document.createElement("select");
        radiusSelect.id = "schoolRadius";
        radiusSelect.className =
          "mt-2 sm:mt-0 sm:ml-2 px-3 py-2 rounded-lg border bg-white text-sm " +
          "dark:bg-zinc-800 dark:border-zinc-700 dark:hover:bg-zinc-700";

        const options = [
          { value: "0",  label: "Exact ZIP only" },
          { value: "10", label: "Within 10 mi" },
          { value: "25", label: "Within 25 mi" },
          { value: "50", label: "Within 50 mi" },
        ];
        options.forEach(opt => {
          const o = document.createElement("option");
          o.value = opt.value;
          o.textContent = opt.label;
          radiusSelect.appendChild(o);
        });

        // insert right after the ZIP input
        elQuery.parentElement.insertBefore(radiusSelect, elQuery.nextSibling);

        // re-filter when radius changes (only if there's already a query or location)
        radiusSelect.addEventListener("change", () => {
          const hasZip = elQuery && elQuery.value.trim();
          if (userLoc) {
            filterByUserLocation();
          } else if (hasZip) {
            filterList();
          }
        });
      }

      function mapsDirHref(address){
        return "https://www.google.com/maps/dir/?api=1&destination=" + encodeURIComponent(address);
      }

      function card(s){
        const hasPhone = !!s.phone;
        const hasSite  = !!s.website;
        return `
          <article class="rounded-2xl border border-zinc-200 bg-white shadow p-5
                          dark:bg-zinc-800 dark:border-zinc-700">
            <h4 class="text-lg font-semibold">${s.name}</h4>
            <p class="mt-1 text-sm text-zinc-600 dark:text-zinc-300">${s.address}</p>
            <div class="mt-3 flex flex-wrap gap-2">
              <a href="${mapsDirHref(s.address)}" target="_blank" rel="noopener"
                 class="px-3 py-1.5 rounded-lg bg-black text-white text-sm hover:opacity-90
                        dark:bg-zinc-100 dark:text-zinc-900">Directions</a>
              ${hasSite ? `
              <a href="${s.website}" target="_blank" rel="noopener"
                 class="px-3 py-1.5 rounded-lg border bg-white text-sm hover:bg-zinc-100
                        dark:bg-zinc-900 dark:border-zinc-700 dark:hover:bg-zinc-700">Website</a>` : ``}
              ${hasPhone ? `
              <a href="tel:${s.phone.replace(/[^+\d]/g,'')}"
                 class="px-3 py-1.5 rounded-lg border bg-white text-sm hover:bg-zinc-100
                        dark:bg-zinc-900 dark:border-zinc-700 dark:hover:bg-zinc-700">Call</a>` : ``}
            </div>
            <div class="mt-2 text-xs text-zinc-500 dark:text-zinc-400" data-distance-for="${s.id}"></div>
          </article>
        `;
      }

      function render(list){
        elGrid.innerHTML = list.map(card).join("");
        elEmpty.classList.toggle("hidden", list.length > 0);
        elCount.textContent = `${list.length} result${list.length===1?"":"s"}`;
      }

      // Haversine distance in miles
      function distanceMiles(lat1, lon1, lat2, lon2) {
        const R = 3958.8; // miles
        const toRad = d => d * Math.PI / 180;
        const dLat = toRad(lat2 - lat1);
        const dLon = toRad(lon2 - lon1);
        const a =
          Math.sin(dLat/2) * Math.sin(dLat/2) +
          Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
          Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
      }

      // ZIP / text-based filtering
      function filterList(){
        const qRaw = (elQuery && elQuery.value ? elQuery.value : "").trim();
        const q = qRaw.toLowerCase();

        userLoc = null; // if they start typing again, we treat it as a query search

        // if no query, show nothing
        if (!q) {
          filtered = [];
          render(filtered);
          return;
        }

        const isZip = /^\d{5}$/.test(qRaw);
        const radius = radiusSelect ? parseInt(radiusSelect.value, 10) || 0 : 0;

        // SIMPLE MODE: not a ZIP or radius == 0 → normal text search
        if (!isZip || radius === 0) {
          filtered = SCHOOLS.filter(s =>
            (s.name + " " + s.address).toLowerCase().includes(q)
          );
          render(filtered);
          return;
        }

        // ZIP + radius: center on schools with that ZIP, then expand
        const exactZipSchools = SCHOOLS.filter(s =>
          s.address && s.address.includes(qRaw) && s.coords
        );

        if (!exactZipSchools.length) {
          // fallback to text search if we can't find coords for that ZIP
          filtered = SCHOOLS.filter(s =>
            (s.name + " " + s.address).toLowerCase().includes(q)
          );
          render(filtered);
          return;
        }

        // center = average of coords of exact-zip schools
        const center = exactZipSchools.reduce(
          (acc, s) => {
            acc.lat += s.coords.lat;
            acc.lng += s.coords.lng;
            return acc;
          },
          { lat: 0, lng: 0 }
        );
        center.lat /= exactZipSchools.length;
        center.lng /= exactZipSchools.length;

        filtered = SCHOOLS.filter(s => {
          if (!s.coords) return false;
          const d = distanceMiles(center.lat, center.lng, s.coords.lat, s.coords.lng);
          return d <= radius;
        });

        render(filtered);
      }

      // Location-based filtering (Use my location)
      function filterByUserLocation(){
        if (!userLoc) {
          filtered = [];
          render(filtered);
          return;
        }
        let radius = radiusSelect ? parseInt(radiusSelect.value, 10) || 0 : 0;
        if (radius === 0) {
          // if user chose "Exact ZIP only", default to 10 miles for location-based
          radius = 10;
          if (radiusSelect) radiusSelect.value = "10";
        }

        filtered = SCHOOLS.filter(s => {
          if (!s.coords) return false;
          const d = distanceMiles(userLoc.lat, userLoc.lng, s.coords.lat, s.coords.lng);
          return d <= radius;
        });

        render(filtered);
      }

      async function init() {
        try {
          const res = await fetch(JSON_URL, { cache: "no-store" });
          if (!res.ok) throw new Error("Failed to load schools JSON");
          SCHOOLS  = await res.json();

          // start with no results
          filtered = [];
          render(filtered);

          if (elQuery) {
            elQuery.addEventListener("input", filterList);
          }

          if (btnGeo) {
            btnGeo.addEventListener("click", () => {
              if (!navigator.geolocation) {
                alert("Geolocation not supported on this device/browser.");
                return;
              }
              navigator.geolocation.getCurrentPosition(
                pos => {
                  userLoc = {
                    lat: pos.coords.latitude,
                    lng: pos.coords.longitude
                  };
                  filterByUserLocation();
                },
                err => {
                  console.warn("Geolocation error:", err);
                  alert("Could not get your location. You can still search by city/ZIP.");
                },
                { enableHighAccuracy: true, timeout: 8000 }
              );
            });
          }

          if (btnReset) {
            btnReset.addEventListener("click", () => {
              if (elQuery) elQuery.value = "";
              if (radiusSelect) radiusSelect.value = "0";
              userLoc = null;
              filtered = [];
              render(filtered);
            });
          }
        } catch (err) {
          console.error("Error loading school list:", err);
          render([]);
        }
      }

      init();
    })();
  </script>
</body>
</html>
