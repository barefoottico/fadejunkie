<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>FadeJunkie — Onboarding Wizard</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-zinc-50 text-zinc-900 dark:bg-zinc-950 dark:text-zinc-100">

<section class="max-w-xl mx-auto p-6 sm:p-10">

  <!-- Progress Bar -->
  <div class="w-full h-1.5 bg-zinc-200 dark:bg-zinc-800 rounded-full">
    <div id="progressBar" class="h-full bg-zinc-900 dark:bg-white rounded-full transition-all duration-300" style="width: 11%;"></div>
  </div>

  <form id="wizardForm" class="mt-10">

    <!-- Slide container -->
    <div id="slides" class="relative min-h-[420px] overflow-hidden">
      
      <!-- Slide 0: Welcome -->
      <div class="slide">
        <h1 class="text-xl font-semibold">Let’s build your profile</h1>
        <p class="text-sm text-zinc-500 mt-2">We’ll ask quick questions. You’ll get a killer page.</p>
        <button type="button" id="startBtn" class="mt-12 w-full py-3 rounded-lg bg-zinc-900 text-white hover:opacity-90">
          Start →
        </button>
      </div>

      <!-- Slide 1: Shop Name -->
      <div class="slide hidden">
        <h2 class="text-lg font-medium">What’s your shop called?</h2>
        <input name="name" required class="input mt-4" placeholder="Shop name">
        <input name="tagline" class="input mt-3" placeholder="Short tagline (optional)">
      </div>

      <!-- Slide 2: Address -->
      <div class="slide hidden">
        <h2 class="text-lg font-medium">Where is it located?</h2>
        <input name="address" placeholder="Street Address" required class="input mt-4">
        <input name="city" placeholder="City" required class="input mt-3">
        <div class="grid grid-cols-3 gap-3 mt-3">
          <input name="state" placeholder="ST" required class="input text-center">
          <input name="zip" placeholder="ZIP" required class="input text-center">
          <select name="timezone" class="input" required>
            <option value="America/Chicago" selected>CST/CDT</option>
            <option value="America/Denver">MST/MDT</option>
            <option value="America/Los_Angeles">PST/PDT</option>
            <option value="America/New_York">EST/EDT</option>
          </select>
        </div>
      </div>

      <!-- Slide 3: Contact -->
      <div class="slide hidden">
        <h2 class="text-lg font-medium">Phone, booking & email</h2>
        <input name="phone" placeholder="(210) 555-1234" required class="input mt-4">
        <input name="booking_url_shop" placeholder="Booking link (Booksy/Squire/etc.)" required class="input mt-3">
        <input name="email" type="email" placeholder="Public email (optional)" class="input mt-3">
      </div>

      <!-- Slide 4: About -->
      <div class="slide hidden">
        <h2 class="text-lg font-medium">Tell customers what makes you great</h2>
        <textarea name="about" rows="4" required class="input mt-4" placeholder="Short, dope description"></textarea>
      </div>

      <!-- Slide 5: Hours -->
      <div class="slide hidden">
        <h2 class="text-lg font-medium">Business hours</h2>
        <p class="text-xs text-zinc-500 mt-1">We’ll sync this with your Open/Closed badge.</p>
        <div id="hoursGrid" class="mt-4 space-y-2 text-sm"></div>
        <p class="text-[11px] text-zinc-500 mt-2">Leave a day blank to mark closed.</p>
      </div>

      <!-- Slide 6: Logo -->
      <div class="slide hidden">
        <h2 class="text-lg font-medium">Logo upload</h2>
        <input type="file" name="logo" accept="image/*" required class="input-file mt-4">
      </div>

      <!-- Slide 7: Banner -->
      <div class="slide hidden">
        <h2 class="text-lg font-medium">Shop Banner</h2>
        <input type="file" name="hero" accept="image/*" required class="input-file mt-4">
      </div>

      <!-- Slide 8: Submit -->
      <div class="slide hidden text-center">
        <h2 class="text-lg font-medium">Done!</h2>
        <p class="text-sm text-zinc-400 mt-2">Submit and we’ll handle the rest.</p>
        <button type="submit" class="mt-10 w-full py-3 rounded-lg bg-zinc-900 text-white hover:opacity-90">
          Submit for review ✅
        </button>
        <p id="submitHint" class="text-xs text-zinc-500 mt-3">Uploads go to Firebase. Then we open a PR in GitHub for approval.</p>
      </div>

    </div>

    <!-- Navigation Controls -->
    <div class="flex justify-between items-center mt-6">
      <button type="button" id="backBtn" class="text-sm text-zinc-500">← Back</button>
      <button type="button" id="nextBtn" class="text-sm bg-zinc-900 text-white px-4 py-2 rounded-lg hover:opacity-90">Next →</button>
    </div>

  </form>
</section>

<style>
.input { @apply w-full rounded-lg border border-zinc-300 dark:border-zinc-700 bg-transparent px-3 py-2 text-sm; }
.input-file { @apply block text-xs rounded-lg cursor-pointer border border-zinc-300 dark:border-zinc-700 file:mr-3 file:px-3 file:py-1.5 file:rounded-md file:border-0 file:bg-zinc-900 file:text-white hover:file:bg-zinc-800; }
.slide { @apply absolute inset-0 transition-opacity duration-300; }
</style>

  <script>
  window.FJ_API_URL = "https://fadejunkie.vercel.app/api/publish-shop";
</script>

<!-- ONE SCRIPT: Firebase + wizard + submit -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
  import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-storage.js";
  import { getFirestore, doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

  // ---- API endpoint (fix routing here) ----
  // If your function is deployed on Vercel/Netlify, put the full URL:
  const PUBLISH_API = "/api/publish-shop"; // or "https://your-vercel-app.vercel.app/api/publish-shop"

  // ---- Firebase config (project you pasted earlier) ----
  const firebaseConfig = {
    apiKey: "AIzaSyDriFned4ysHHBNJlNUWm9D4yA1N8HH-IM",
    authDomain: "fadejunkie-barbershop-onboard.firebaseapp.com",
    projectId: "fadejunkie-barbershop-onboard",
    // A) Use the project’s default bucket shown in Firebase:
    storageBucket: "fadejunkie-barbershop-onboard.appspot.com",
    // B) OR force your manual bucket instead (uncomment next line & comment the one above):
    // storageBucket: "fadejunkie-media.appspot.com",
    messagingSenderId: "483229378363",
    appId: "1:483229378363:web:ff30f0c32bb923b73ff91e",
    measurementId: "G-NGYEJK6VL0"
  };

  const app = initializeApp(firebaseConfig);

  // If you picked A, default is fine:
  const storage = getStorage(app);

  // If you picked B and want to force the manual bucket, use this instead:
  // const storage = getStorage(app, "gs://fadejunkie-media");

  const db = getFirestore(app);

  // ------------ Wizard helpers ------------
  const $form = document.getElementById("wizardForm");
  const get = (n) => $form.elements[n]?.value?.trim() || "";
  const days = [["mon","Mon"],["tue","Tue"],["wed","Wed"],["thu","Thu"],["fri","Fri"],["sat","Sat"],["sun","Sun"]];

  function toId(name, city=""){ return (name+"-"+city).toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,""); }

  async function uploadFile(path, file){
    if(!file) return "";
    const r = ref(storage, path);
    await uploadBytes(r, file, { contentType: file.type });
    return await getDownloadURL(r);
  }

  async function collectPayload(){
    const name = get("name");
    const tagline = get("tagline");
    const address = get("address");
    const city = get("city");
    const state = get("state");
    const zip = get("zip");
    const timezone = get("timezone") || "America/Chicago";
    const phone = get("phone");
    const email = get("email");
    const booking = get("booking_url_shop");
    const about = get("about");
    const shopId = toId(name, city || "shop");

    const logoFile = $form.elements["logo"]?.files?.[0];
    const heroFile = $form.elements["hero"]?.files?.[0];
    const logoExt = logoFile?.name?.split(".").pop() || "jpg";
    const heroExt = heroFile?.name?.split(".").pop() || "jpg";

    const logoUrl = await uploadFile(`shops/${shopId}/logo.${logoExt}`, logoFile);
    const heroUrl = await uploadFile(`shops/${shopId}/hero.${heroExt}`, heroFile);

    const hoursDetailed = Object.fromEntries(days.map(([k]) => [k, { open: get(`open_${k}`)||"", close: get(`close_${k}`)||"" }]));

    const shop = {
      id: shopId,
      name, tagline,
      phone, phoneHref: `tel:${phone.replace(/\D+/g,"")}`,
      email,
      address: `${address}${city?`, ${city}`:""}${state?`, ${state}`:""}${zip?` ${zip}`:""}`,
      mapsQuery: `${address} ${city} ${state} ${zip}`.trim(),
      timezone,
      hoursString: "",
      hoursDetailed,
      socials: { instagram:get("instagram"), tiktok:get("tiktok"), facebook:get("facebook") },
      about,
      logo: logoUrl,
      hero: heroUrl,
      booking_url_shop: booking
    };

    return { shop, barbers: [] }; // add barbers later as needed
  }

  // ------------ Submit handler (with loud errors) ------------
  $form.onsubmit = async (e)=>{
    e.preventDefault();
    const btn = e.submitter || $form.querySelector('button[type="submit"]');
    const original = btn.textContent;
    btn.disabled = true; btn.textContent = "Submitting…";

    try {
      // quick sanity log
      console.log("Using bucket:", (await import("https://www.gstatic.com/firebasejs/12.4.0/firebase-storage.js")).getStorage ? storage : "not set");

      const payload = await collectPayload();

      // Save a Firestore copy (optional but helpful)
      await setDoc(doc(db, "submissions", payload.shop.id), { createdAt: serverTimestamp(), ...payload });

      // Post to your API (fix routing by using the constant above)
      const res = await fetch(PUBLISH_API, {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });

      if (!res.ok) {
        const text = await res.text();
        throw new Error(`Publish API error (${res.status}): ${text}`);
      }

      const out = await res.json();
      alert(`Submitted! PR: ${out.prUrl || "check your repo PRs"}`);
    } catch (err) {
      console.error(err);
      alert("Failed: " + err.message);
    } finally {
      btn.disabled = false; btn.textContent = original;
    }
  };
</script>


</body>
</html>
